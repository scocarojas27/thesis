{"ast":null,"code":"'use strict';\n\nvar Class = require('../util/class'),\n    Set = require('../util/set'),\n    URI = require('../util/uri'),\n    assign = require('../util/assign'),\n    toJSON = require('../util/to_json'),\n    Transport = require('./transport');\n\nvar CORS = assign(Class(Transport, {\n  encode: function (messages) {\n    return 'message=' + encodeURIComponent(toJSON(messages));\n  },\n  request: function (messages) {\n    var xhrClass = global.XDomainRequest ? XDomainRequest : XMLHttpRequest,\n        xhr = new xhrClass(),\n        id = ++CORS._id,\n        headers = this._dispatcher.headers,\n        self = this,\n        key;\n    xhr.open('POST', this.endpoint.href, true);\n    xhr.withCredentials = true;\n\n    if (xhr.setRequestHeader) {\n      xhr.setRequestHeader('Pragma', 'no-cache');\n\n      for (key in headers) {\n        if (!headers.hasOwnProperty(key)) continue;\n        xhr.setRequestHeader(key, headers[key]);\n      }\n    }\n\n    var cleanUp = function () {\n      if (!xhr) return false;\n\n      CORS._pending.remove(id);\n\n      xhr.onload = xhr.onerror = xhr.ontimeout = xhr.onprogress = null;\n      xhr = null;\n    };\n\n    xhr.onload = function () {\n      var replies;\n\n      try {\n        replies = JSON.parse(xhr.responseText);\n      } catch (error) {}\n\n      cleanUp();\n      if (replies) self._receive(replies);else self._handleError(messages);\n    };\n\n    xhr.onerror = xhr.ontimeout = function () {\n      cleanUp();\n\n      self._handleError(messages);\n    };\n\n    xhr.onprogress = function () {};\n\n    if (xhrClass === global.XDomainRequest) CORS._pending.add({\n      id: id,\n      xhr: xhr\n    });\n    xhr.send(this.encode(messages));\n    return xhr;\n  }\n}), {\n  _id: 0,\n  _pending: new Set(),\n  isUsable: function (dispatcher, endpoint, callback, context) {\n    if (URI.isSameOrigin(endpoint)) return callback.call(context, false);\n    if (global.XDomainRequest) return callback.call(context, endpoint.protocol === location.protocol);\n\n    if (global.XMLHttpRequest) {\n      var xhr = new XMLHttpRequest();\n      return callback.call(context, xhr.withCredentials !== undefined);\n    }\n\n    return callback.call(context, false);\n  }\n});\nmodule.exports = CORS;","map":{"version":3,"sources":["/home/scocarojas/Documents/prototype/front/node_modules/faye/src/transport/cors.js"],"names":["Class","require","Set","URI","assign","toJSON","Transport","CORS","encode","messages","encodeURIComponent","request","xhrClass","global","XDomainRequest","XMLHttpRequest","xhr","id","_id","headers","_dispatcher","self","key","open","endpoint","href","withCredentials","setRequestHeader","hasOwnProperty","cleanUp","_pending","remove","onload","onerror","ontimeout","onprogress","replies","JSON","parse","responseText","error","_receive","_handleError","add","send","isUsable","dispatcher","callback","context","isSameOrigin","call","protocol","location","undefined","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar Class     = require('../util/class'),\n    Set       = require('../util/set'),\n    URI       = require('../util/uri'),\n    assign    = require('../util/assign'),\n    toJSON    = require('../util/to_json'),\n    Transport = require('./transport');\n\nvar CORS = assign(Class(Transport, {\n  encode: function(messages) {\n    return 'message=' + encodeURIComponent(toJSON(messages));\n  },\n\n  request: function(messages) {\n    var xhrClass = global.XDomainRequest ? XDomainRequest : XMLHttpRequest,\n        xhr      = new xhrClass(),\n        id       = ++CORS._id,\n        headers  = this._dispatcher.headers,\n        self     = this,\n        key;\n\n    xhr.open('POST', this.endpoint.href, true);\n    xhr.withCredentials = true;\n\n    if (xhr.setRequestHeader) {\n      xhr.setRequestHeader('Pragma', 'no-cache');\n      for (key in headers) {\n        if (!headers.hasOwnProperty(key)) continue;\n        xhr.setRequestHeader(key, headers[key]);\n      }\n    }\n\n    var cleanUp = function() {\n      if (!xhr) return false;\n      CORS._pending.remove(id);\n      xhr.onload = xhr.onerror = xhr.ontimeout = xhr.onprogress = null;\n      xhr = null;\n    };\n\n    xhr.onload = function() {\n      var replies;\n      try { replies = JSON.parse(xhr.responseText) } catch (error) {}\n\n      cleanUp();\n\n      if (replies)\n        self._receive(replies);\n      else\n        self._handleError(messages);\n    };\n\n    xhr.onerror = xhr.ontimeout = function() {\n      cleanUp();\n      self._handleError(messages);\n    };\n\n    xhr.onprogress = function() {};\n\n    if (xhrClass === global.XDomainRequest)\n      CORS._pending.add({ id: id, xhr: xhr });\n\n    xhr.send(this.encode(messages));\n    return xhr;\n  }\n}), {\n  _id:      0,\n  _pending: new Set(),\n\n  isUsable: function(dispatcher, endpoint, callback, context) {\n    if (URI.isSameOrigin(endpoint))\n      return callback.call(context, false);\n\n    if (global.XDomainRequest)\n      return callback.call(context, endpoint.protocol === location.protocol);\n\n    if (global.XMLHttpRequest) {\n      var xhr = new XMLHttpRequest();\n      return callback.call(context, xhr.withCredentials !== undefined);\n    }\n    return callback.call(context, false);\n  }\n});\n\nmodule.exports = CORS;\n"]},"metadata":{},"sourceType":"script"}