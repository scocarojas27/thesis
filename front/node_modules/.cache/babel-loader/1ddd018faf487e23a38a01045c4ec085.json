{"ast":null,"code":"'use strict';\n\nvar Class = require('../util/class'),\n    URI = require('../util/uri'),\n    cookies = require('../util/cookies'),\n    assign = require('../util/assign'),\n    Logging = require('../mixins/logging'),\n    Publisher = require('../mixins/publisher'),\n    Transport = require('../transport'),\n    Scheduler = require('./scheduler');\n\nvar Dispatcher = Class({\n  className: 'Dispatcher',\n  MAX_REQUEST_SIZE: 2048,\n  DEFAULT_RETRY: 5,\n  UP: 1,\n  DOWN: 2,\n  initialize: function (client, endpoint, options) {\n    this._client = client;\n    this.endpoint = URI.parse(endpoint);\n    this._alternates = options.endpoints || {};\n    this.cookies = cookies.CookieJar && new cookies.CookieJar();\n    this._disabled = [];\n    this._envelopes = {};\n    this.headers = {};\n    this.retry = options.retry || this.DEFAULT_RETRY;\n    this._scheduler = options.scheduler || Scheduler;\n    this._state = 0;\n    this.transports = {};\n    this.wsExtensions = [];\n    this.proxy = options.proxy || {};\n    if (typeof this._proxy === 'string') this._proxy = {\n      origin: this._proxy\n    };\n    var exts = options.websocketExtensions;\n\n    if (exts) {\n      exts = [].concat(exts);\n\n      for (var i = 0, n = exts.length; i < n; i++) this.addWebsocketExtension(exts[i]);\n    }\n\n    this.tls = options.tls || {};\n    this.tls.ca = this.tls.ca || options.ca;\n\n    for (var type in this._alternates) this._alternates[type] = URI.parse(this._alternates[type]);\n\n    this.maxRequestSize = this.MAX_REQUEST_SIZE;\n  },\n  endpointFor: function (connectionType) {\n    return this._alternates[connectionType] || this.endpoint;\n  },\n  addWebsocketExtension: function (extension) {\n    this.wsExtensions.push(extension);\n  },\n  disable: function (feature) {\n    this._disabled.push(feature);\n\n    Transport.disable(feature);\n  },\n  setHeader: function (name, value) {\n    this.headers[name] = value;\n  },\n  close: function () {\n    var transport = this._transport;\n    delete this._transport;\n    if (transport) transport.close();\n  },\n  getConnectionTypes: function () {\n    return Transport.getConnectionTypes();\n  },\n  selectTransport: function (transportTypes) {\n    Transport.get(this, transportTypes, this._disabled, function (transport) {\n      this.debug('Selected ? transport for ?', transport.connectionType, transport.endpoint.href);\n      if (transport === this._transport) return;\n      if (this._transport) this._transport.close();\n      this._transport = transport;\n      this.connectionType = transport.connectionType;\n    }, this);\n  },\n  sendMessage: function (message, timeout, options) {\n    options = options || {};\n    var id = message.id,\n        attempts = options.attempts,\n        deadline = options.deadline && new Date().getTime() + options.deadline * 1000,\n        envelope = this._envelopes[id],\n        scheduler;\n\n    if (!envelope) {\n      scheduler = new this._scheduler(message, {\n        timeout: timeout,\n        interval: this.retry,\n        attempts: attempts,\n        deadline: deadline\n      });\n      envelope = this._envelopes[id] = {\n        message: message,\n        scheduler: scheduler\n      };\n    }\n\n    this._sendEnvelope(envelope);\n  },\n  _sendEnvelope: function (envelope) {\n    if (!this._transport) return;\n    if (envelope.request || envelope.timer) return;\n    var message = envelope.message,\n        scheduler = envelope.scheduler,\n        self = this;\n\n    if (!scheduler.isDeliverable()) {\n      scheduler.abort();\n      delete this._envelopes[message.id];\n      return;\n    }\n\n    envelope.timer = global.setTimeout(function () {\n      self.handleError(message);\n    }, scheduler.getTimeout() * 1000);\n    scheduler.send();\n    envelope.request = this._transport.sendMessage(message);\n  },\n  handleResponse: function (reply) {\n    var envelope = this._envelopes[reply.id];\n\n    if (reply.successful !== undefined && envelope) {\n      envelope.scheduler.succeed();\n      delete this._envelopes[reply.id];\n      global.clearTimeout(envelope.timer);\n    }\n\n    this.trigger('message', reply);\n    if (this._state === this.UP) return;\n    this._state = this.UP;\n\n    this._client.trigger('transport:up');\n  },\n  handleError: function (message, immediate) {\n    var envelope = this._envelopes[message.id],\n        request = envelope && envelope.request,\n        self = this;\n    if (!request) return;\n    request.then(function (req) {\n      if (req && req.abort) req.abort();\n    });\n    var scheduler = envelope.scheduler;\n    scheduler.fail();\n    global.clearTimeout(envelope.timer);\n    envelope.request = envelope.timer = null;\n\n    if (immediate) {\n      this._sendEnvelope(envelope);\n    } else {\n      envelope.timer = global.setTimeout(function () {\n        envelope.timer = null;\n\n        self._sendEnvelope(envelope);\n      }, scheduler.getInterval() * 1000);\n    }\n\n    if (this._state === this.DOWN) return;\n    this._state = this.DOWN;\n\n    this._client.trigger('transport:down');\n  }\n});\n\nDispatcher.create = function (client, endpoint, options) {\n  return new Dispatcher(client, endpoint, options);\n};\n\nassign(Dispatcher.prototype, Publisher);\nassign(Dispatcher.prototype, Logging);\nmodule.exports = Dispatcher;","map":{"version":3,"sources":["/home/scocarojas/Documents/prototype/node_modules/faye/src/protocol/dispatcher.js"],"names":["Class","require","URI","cookies","assign","Logging","Publisher","Transport","Scheduler","Dispatcher","className","MAX_REQUEST_SIZE","DEFAULT_RETRY","UP","DOWN","initialize","client","endpoint","options","_client","parse","_alternates","endpoints","CookieJar","_disabled","_envelopes","headers","retry","_scheduler","scheduler","_state","transports","wsExtensions","proxy","_proxy","origin","exts","websocketExtensions","concat","i","n","length","addWebsocketExtension","tls","ca","type","maxRequestSize","endpointFor","connectionType","extension","push","disable","feature","setHeader","name","value","close","transport","_transport","getConnectionTypes","selectTransport","transportTypes","get","debug","href","sendMessage","message","timeout","id","attempts","deadline","Date","getTime","envelope","interval","_sendEnvelope","request","timer","self","isDeliverable","abort","global","setTimeout","handleError","getTimeout","send","handleResponse","reply","successful","undefined","succeed","clearTimeout","trigger","immediate","then","req","fail","getInterval","create","prototype","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar Class     = require('../util/class'),\n    URI       = require('../util/uri'),\n    cookies   = require('../util/cookies'),\n    assign    = require('../util/assign'),\n    Logging   = require('../mixins/logging'),\n    Publisher = require('../mixins/publisher'),\n    Transport = require('../transport'),\n    Scheduler = require('./scheduler');\n\nvar Dispatcher = Class({ className: 'Dispatcher',\n  MAX_REQUEST_SIZE: 2048,\n  DEFAULT_RETRY:    5,\n\n  UP:   1,\n  DOWN: 2,\n\n  initialize: function(client, endpoint, options) {\n    this._client     = client;\n    this.endpoint    = URI.parse(endpoint);\n    this._alternates = options.endpoints || {};\n\n    this.cookies      = cookies.CookieJar && new cookies.CookieJar();\n    this._disabled    = [];\n    this._envelopes   = {};\n    this.headers      = {};\n    this.retry        = options.retry || this.DEFAULT_RETRY;\n    this._scheduler   = options.scheduler || Scheduler;\n    this._state       = 0;\n    this.transports   = {};\n    this.wsExtensions = [];\n\n    this.proxy = options.proxy || {};\n    if (typeof this._proxy === 'string') this._proxy = { origin: this._proxy };\n\n    var exts = options.websocketExtensions;\n    if (exts) {\n      exts = [].concat(exts);\n      for (var i = 0, n = exts.length; i < n; i++)\n        this.addWebsocketExtension(exts[i]);\n    }\n\n    this.tls = options.tls || {};\n    this.tls.ca = this.tls.ca || options.ca;\n\n    for (var type in this._alternates)\n      this._alternates[type] = URI.parse(this._alternates[type]);\n\n    this.maxRequestSize = this.MAX_REQUEST_SIZE;\n  },\n\n  endpointFor: function(connectionType) {\n    return this._alternates[connectionType] || this.endpoint;\n  },\n\n  addWebsocketExtension: function(extension) {\n    this.wsExtensions.push(extension);\n  },\n\n  disable: function(feature) {\n    this._disabled.push(feature);\n    Transport.disable(feature);\n  },\n\n  setHeader: function(name, value) {\n    this.headers[name] = value;\n  },\n\n  close: function() {\n    var transport = this._transport;\n    delete this._transport;\n    if (transport) transport.close();\n  },\n\n  getConnectionTypes: function() {\n    return Transport.getConnectionTypes();\n  },\n\n  selectTransport: function(transportTypes) {\n    Transport.get(this, transportTypes, this._disabled, function(transport) {\n      this.debug('Selected ? transport for ?', transport.connectionType, transport.endpoint.href);\n\n      if (transport === this._transport) return;\n      if (this._transport) this._transport.close();\n\n      this._transport = transport;\n      this.connectionType = transport.connectionType;\n    }, this);\n  },\n\n  sendMessage: function(message, timeout, options) {\n    options = options || {};\n\n    var id       = message.id,\n        attempts = options.attempts,\n        deadline = options.deadline && new Date().getTime() + (options.deadline * 1000),\n        envelope = this._envelopes[id],\n        scheduler;\n\n    if (!envelope) {\n      scheduler = new this._scheduler(message, { timeout: timeout, interval: this.retry, attempts: attempts, deadline: deadline });\n      envelope  = this._envelopes[id] = { message: message, scheduler: scheduler };\n    }\n\n    this._sendEnvelope(envelope);\n  },\n\n  _sendEnvelope: function(envelope) {\n    if (!this._transport) return;\n    if (envelope.request || envelope.timer) return;\n\n    var message   = envelope.message,\n        scheduler = envelope.scheduler,\n        self      = this;\n\n    if (!scheduler.isDeliverable()) {\n      scheduler.abort();\n      delete this._envelopes[message.id];\n      return;\n    }\n\n    envelope.timer = global.setTimeout(function() {\n      self.handleError(message);\n    }, scheduler.getTimeout() * 1000);\n\n    scheduler.send();\n    envelope.request = this._transport.sendMessage(message);\n  },\n\n  handleResponse: function(reply) {\n    var envelope = this._envelopes[reply.id];\n\n    if (reply.successful !== undefined && envelope) {\n      envelope.scheduler.succeed();\n      delete this._envelopes[reply.id];\n      global.clearTimeout(envelope.timer);\n    }\n\n    this.trigger('message', reply);\n\n    if (this._state === this.UP) return;\n    this._state = this.UP;\n    this._client.trigger('transport:up');\n  },\n\n  handleError: function(message, immediate) {\n    var envelope = this._envelopes[message.id],\n        request  = envelope && envelope.request,\n        self     = this;\n\n    if (!request) return;\n\n    request.then(function(req) {\n      if (req && req.abort) req.abort();\n    });\n\n    var scheduler = envelope.scheduler;\n    scheduler.fail();\n\n    global.clearTimeout(envelope.timer);\n    envelope.request = envelope.timer = null;\n\n    if (immediate) {\n      this._sendEnvelope(envelope);\n    } else {\n      envelope.timer = global.setTimeout(function() {\n        envelope.timer = null;\n        self._sendEnvelope(envelope);\n      }, scheduler.getInterval() * 1000);\n    }\n\n    if (this._state === this.DOWN) return;\n    this._state = this.DOWN;\n    this._client.trigger('transport:down');\n  }\n});\n\nDispatcher.create = function(client, endpoint, options) {\n  return new Dispatcher(client, endpoint, options);\n};\n\nassign(Dispatcher.prototype, Publisher);\nassign(Dispatcher.prototype, Logging);\n\nmodule.exports = Dispatcher;\n"]},"metadata":{},"sourceType":"script"}