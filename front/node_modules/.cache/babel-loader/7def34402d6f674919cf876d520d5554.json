{"ast":null,"code":"// Browser Request\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\nvar XHR = XMLHttpRequest;\nif (!XHR) throw new Error('missing XMLHttpRequest');\nrequest.log = {\n  'trace': noop,\n  'debug': noop,\n  'info': noop,\n  'warn': noop,\n  'error': noop\n};\nvar DEFAULT_TIMEOUT = 3 * 60 * 1000; // 3 minutes\n//\n// request\n//\n\nfunction request(options, callback) {\n  // The entry-point to the API: prep the options object and pass the real work to run_xhr.\n  if (typeof callback !== 'function') throw new Error('Bad callback given: ' + callback);\n  if (!options) throw new Error('No options given');\n  var options_onResponse = options.onResponse; // Save this for later.\n\n  if (typeof options === 'string') options = {\n    'uri': options\n  };else options = JSON.parse(JSON.stringify(options)); // Use a duplicate for mutating.\n\n  options.onResponse = options_onResponse; // And put it back.\n\n  if (options.verbose) request.log = getLogger();\n\n  if (options.url) {\n    options.uri = options.url;\n    delete options.url;\n  }\n\n  if (!options.uri && options.uri !== \"\") throw new Error(\"options.uri is a required argument\");\n  if (typeof options.uri != \"string\") throw new Error(\"options.uri must be a string\");\n  var unsupported_options = ['proxy', '_redirectsFollowed', 'maxRedirects', 'followRedirect'];\n\n  for (var i = 0; i < unsupported_options.length; i++) if (options[unsupported_options[i]]) throw new Error(\"options.\" + unsupported_options[i] + \" is not supported\");\n\n  options.callback = callback;\n  options.method = options.method || 'GET';\n  options.headers = options.headers || {};\n  options.body = options.body || null;\n  options.timeout = options.timeout || request.DEFAULT_TIMEOUT;\n  if (options.headers.host) throw new Error(\"Options.headers.host is not supported\");\n\n  if (options.json) {\n    options.headers.accept = options.headers.accept || 'application/json';\n    if (options.method !== 'GET') options.headers['content-type'] = 'application/json';\n    if (typeof options.json !== 'boolean') options.body = JSON.stringify(options.json);else if (typeof options.body !== 'string' && options.body !== null) options.body = JSON.stringify(options.body);\n  } //BEGIN QS Hack\n\n\n  var serialize = function (obj) {\n    var str = [];\n\n    for (var p in obj) if (obj.hasOwnProperty(p)) {\n      str.push(encodeURIComponent(p) + \"=\" + encodeURIComponent(obj[p]));\n    }\n\n    return str.join(\"&\");\n  };\n\n  if (options.qs) {\n    var qs = typeof options.qs == 'string' ? options.qs : serialize(options.qs);\n\n    if (options.uri.indexOf('?') !== -1) {\n      //no get params\n      options.uri = options.uri + '&' + qs;\n    } else {\n      //existing get params\n      options.uri = options.uri + '?' + qs;\n    }\n  } //END QS Hack\n  //BEGIN FORM Hack\n\n\n  var multipart = function (obj) {\n    //todo: support file type (useful?)\n    var result = {};\n    result.boundry = '-------------------------------' + Math.floor(Math.random() * 1000000000);\n    var lines = [];\n\n    for (var p in obj) {\n      if (obj.hasOwnProperty(p)) {\n        lines.push('--' + result.boundry + \"\\n\" + 'Content-Disposition: form-data; name=\"' + p + '\"' + \"\\n\" + \"\\n\" + obj[p] + \"\\n\");\n      }\n    }\n\n    lines.push('--' + result.boundry + '--');\n    result.body = lines.join('');\n    result.length = result.body.length;\n    result.type = 'multipart/form-data; boundary=' + result.boundry;\n    return result;\n  };\n\n  if (options.form) {\n    if (typeof options.form == 'string') throw 'form name unsupported';\n\n    if (options.method === 'POST') {\n      var encoding = (options.encoding || 'application/x-www-form-urlencoded').toLowerCase();\n      options.headers['content-type'] = encoding;\n\n      switch (encoding) {\n        case 'application/x-www-form-urlencoded':\n          options.body = serialize(options.form).replace(/%20/g, \"+\");\n          break;\n\n        case 'multipart/form-data':\n          var multi = multipart(options.form); //options.headers['content-length'] = multi.length;\n\n          options.body = multi.body;\n          options.headers['content-type'] = multi.type;\n          break;\n\n        default:\n          throw new Error('unsupported encoding:' + encoding);\n      }\n    }\n  } //END FORM Hack\n  // If onResponse is boolean true, call back immediately when the response is known,\n  // not when the full request is complete.\n\n\n  options.onResponse = options.onResponse || noop;\n\n  if (options.onResponse === true) {\n    options.onResponse = callback;\n    options.callback = noop;\n  } // XXX Browsers do not like this.\n  //if(options.body)\n  //  options.headers['content-length'] = options.body.length;\n  // HTTP basic authentication\n\n\n  if (!options.headers.authorization && options.auth) options.headers.authorization = 'Basic ' + b64_enc(options.auth.username + ':' + options.auth.password);\n  return run_xhr(options);\n}\n\nvar req_seq = 0;\n\nfunction run_xhr(options) {\n  var xhr = new XHR(),\n      timed_out = false,\n      is_cors = is_crossDomain(options.uri),\n      supports_cors = ('withCredentials' in xhr);\n  req_seq += 1;\n  xhr.seq_id = req_seq;\n  xhr.id = req_seq + ': ' + options.method + ' ' + options.uri;\n  xhr._id = xhr.id; // I know I will type \"_id\" from habit all the time.\n\n  if (is_cors && !supports_cors) {\n    var cors_err = new Error('Browser does not support cross-origin request: ' + options.uri);\n    cors_err.cors = 'unsupported';\n    return options.callback(cors_err, xhr);\n  }\n\n  xhr.timeoutTimer = setTimeout(too_late, options.timeout);\n\n  function too_late() {\n    timed_out = true;\n    var er = new Error('ETIMEDOUT');\n    er.code = 'ETIMEDOUT';\n    er.duration = options.timeout;\n    request.log.error('Timeout', {\n      'id': xhr._id,\n      'milliseconds': options.timeout\n    });\n    return options.callback(er, xhr);\n  } // Some states can be skipped over, so remember what is still incomplete.\n\n\n  var did = {\n    'response': false,\n    'loading': false,\n    'end': false\n  };\n  xhr.onreadystatechange = on_state_change;\n  xhr.open(options.method, options.uri, true); // asynchronous\n\n  if (is_cors) xhr.withCredentials = !!options.withCredentials;\n\n  for (var key in options.headers) xhr.setRequestHeader(key, options.headers[key]);\n\n  xhr.send(options.body);\n  return xhr;\n\n  function on_state_change(event) {\n    if (timed_out) return request.log.debug('Ignoring timed out state change', {\n      'state': xhr.readyState,\n      'id': xhr.id\n    });\n    request.log.debug('State change', {\n      'state': xhr.readyState,\n      'id': xhr.id,\n      'timed_out': timed_out\n    });\n\n    if (xhr.readyState === 1) {\n      request.log.debug('Request started', {\n        'id': xhr.id\n      });\n    } else if (xhr.readyState === 2) on_response();else if (xhr.readyState === 3) {\n      on_response();\n      on_loading();\n    } else if (xhr.readyState === 4) {\n      on_response();\n      on_loading();\n      on_end();\n    }\n  }\n\n  function on_response() {\n    if (did.response) return;\n    did.response = true;\n    request.log.debug('Got response', {\n      'id': xhr.id,\n      'status': xhr.status\n    });\n    clearTimeout(xhr.timeoutTimer);\n    xhr.statusCode = xhr.status; // Node request compatibility\n    // Detect failed CORS requests.\n\n    if (is_cors && xhr.statusCode == 0) {\n      var cors_err = new Error('CORS request rejected: ' + options.uri);\n      cors_err.cors = 'rejected'; // Do not process this request further.\n\n      did.loading = true;\n      did.end = true;\n      return options.callback(cors_err, xhr);\n    }\n\n    options.onResponse(null, xhr);\n  }\n\n  function on_loading() {\n    if (did.loading) return;\n    did.loading = true;\n    request.log.debug('Response body loading', {\n      'id': xhr.id\n    }); // TODO: Maybe simulate \"data\" events by watching xhr.responseText\n  }\n\n  function on_end() {\n    if (did.end) return;\n    did.end = true;\n    request.log.debug('Request done', {\n      'id': xhr.id\n    });\n    xhr.body = xhr.responseText;\n\n    if (options.json) {\n      try {\n        xhr.body = JSON.parse(xhr.responseText);\n      } catch (er) {\n        return options.callback(er, xhr);\n      }\n    }\n\n    options.callback(null, xhr, xhr.body);\n  }\n} // request\n\n\nrequest.withCredentials = false;\nrequest.DEFAULT_TIMEOUT = DEFAULT_TIMEOUT; //\n// defaults\n//\n\nrequest.defaults = function (options, requester) {\n  var def = function (method) {\n    var d = function (params, callback) {\n      if (typeof params === 'string') params = {\n        'uri': params\n      };else {\n        params = JSON.parse(JSON.stringify(params));\n      }\n\n      for (var i in options) {\n        if (params[i] === undefined) params[i] = options[i];\n      }\n\n      return method(params, callback);\n    };\n\n    return d;\n  };\n\n  var de = def(request);\n  de.get = def(request.get);\n  de.post = def(request.post);\n  de.put = def(request.put);\n  de.head = def(request.head);\n  return de;\n}; //\n// HTTP method shortcuts\n//\n\n\nvar shortcuts = ['get', 'put', 'post', 'head'];\nshortcuts.forEach(function (shortcut) {\n  var method = shortcut.toUpperCase();\n  var func = shortcut.toLowerCase();\n\n  request[func] = function (opts) {\n    if (typeof opts === 'string') opts = {\n      'method': method,\n      'uri': opts\n    };else {\n      opts = JSON.parse(JSON.stringify(opts));\n      opts.method = method;\n    }\n    var args = [opts].concat(Array.prototype.slice.apply(arguments, [1]));\n    return request.apply(this, args);\n  };\n}); //\n// CouchDB shortcut\n//\n\nrequest.couch = function (options, callback) {\n  if (typeof options === 'string') options = {\n    'uri': options\n  }; // Just use the request API to do JSON.\n\n  options.json = true;\n  if (options.body) options.json = options.body;\n  delete options.body;\n  callback = callback || noop;\n  var xhr = request(options, couch_handler);\n  return xhr;\n\n  function couch_handler(er, resp, body) {\n    if (er) return callback(er, resp, body);\n\n    if ((resp.statusCode < 200 || resp.statusCode > 299) && body.error) {\n      // The body is a Couch JSON object indicating the error.\n      er = new Error('CouchDB error: ' + (body.error.reason || body.error.error));\n\n      for (var key in body) er[key] = body[key];\n\n      return callback(er, resp, body);\n    }\n\n    return callback(er, resp, body);\n  }\n}; //\n// Utility\n//\n\n\nfunction noop() {}\n\nfunction getLogger() {\n  var logger = {},\n      levels = ['trace', 'debug', 'info', 'warn', 'error'],\n      level,\n      i;\n\n  for (i = 0; i < levels.length; i++) {\n    level = levels[i];\n    logger[level] = noop;\n    if (typeof console !== 'undefined' && console && console[level]) logger[level] = formatted(console, level);\n  }\n\n  return logger;\n}\n\nfunction formatted(obj, method) {\n  return formatted_logger;\n\n  function formatted_logger(str, context) {\n    if (typeof context === 'object') str += ' ' + JSON.stringify(context);\n    return obj[method].call(obj, str);\n  }\n} // Return whether a URL is a cross-domain request.\n\n\nfunction is_crossDomain(url) {\n  // Fix for React Native. CORS does noet exist in that environment\n  if (!window.location) {\n    return false;\n  }\n\n  var rurl = /^([\\w\\+\\.\\-]+:)(?:\\/\\/([^\\/?#:]*)(?::(\\d+))?)?/; // jQuery #8138, IE may throw an exception when accessing\n  // a field from window.location if document.domain has been set\n\n  var ajaxLocation;\n\n  try {\n    ajaxLocation = location.href;\n  } catch (e) {\n    // Use the href attribute of an A element since IE will modify it given document.location\n    ajaxLocation = document.createElement(\"a\");\n    ajaxLocation.href = \"\";\n    ajaxLocation = ajaxLocation.href;\n  }\n\n  var ajaxLocParts = rurl.exec(ajaxLocation.toLowerCase()) || [],\n      parts = rurl.exec(url.toLowerCase());\n  var result = !!(parts && (parts[1] != ajaxLocParts[1] || parts[2] != ajaxLocParts[2] || (parts[3] || (parts[1] === \"http:\" ? 80 : 443)) != (ajaxLocParts[3] || (ajaxLocParts[1] === \"http:\" ? 80 : 443)))); //console.debug('is_crossDomain('+url+') -> ' + result)\n\n  return result;\n} // MIT License from http://phpjs.org/functions/base64_encode:358\n\n\nfunction b64_enc(data) {\n  // Encodes string using MIME base64 algorithm\n  var b64 = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\";\n  var o1,\n      o2,\n      o3,\n      h1,\n      h2,\n      h3,\n      h4,\n      bits,\n      i = 0,\n      ac = 0,\n      enc = \"\",\n      tmp_arr = [];\n\n  if (!data) {\n    return data;\n  } // assume utf8 data\n  // data = this.utf8_encode(data+'');\n\n\n  do {\n    // pack three octets into four hexets\n    o1 = data.charCodeAt(i++);\n    o2 = data.charCodeAt(i++);\n    o3 = data.charCodeAt(i++);\n    bits = o1 << 16 | o2 << 8 | o3;\n    h1 = bits >> 18 & 0x3f;\n    h2 = bits >> 12 & 0x3f;\n    h3 = bits >> 6 & 0x3f;\n    h4 = bits & 0x3f; // use hexets to index into b64, and append result to encoded string\n\n    tmp_arr[ac++] = b64.charAt(h1) + b64.charAt(h2) + b64.charAt(h3) + b64.charAt(h4);\n  } while (i < data.length);\n\n  enc = tmp_arr.join('');\n\n  switch (data.length % 3) {\n    case 1:\n      enc = enc.slice(0, -2) + '==';\n      break;\n\n    case 2:\n      enc = enc.slice(0, -1) + '=';\n      break;\n  }\n\n  return enc;\n}\n\nmodule.exports = request;","map":{"version":3,"sources":["/home/scocarojas/Documents/prototype/front/node_modules/@stream-io/browser-request/index.js"],"names":["XHR","XMLHttpRequest","Error","request","log","noop","DEFAULT_TIMEOUT","options","callback","options_onResponse","onResponse","JSON","parse","stringify","verbose","getLogger","url","uri","unsupported_options","i","length","method","headers","body","timeout","host","json","accept","serialize","obj","str","p","hasOwnProperty","push","encodeURIComponent","join","qs","indexOf","multipart","result","boundry","Math","floor","random","lines","type","form","encoding","toLowerCase","replace","multi","authorization","auth","b64_enc","username","password","run_xhr","req_seq","xhr","timed_out","is_cors","is_crossDomain","supports_cors","seq_id","id","_id","cors_err","cors","timeoutTimer","setTimeout","too_late","er","code","duration","error","did","onreadystatechange","on_state_change","open","withCredentials","key","setRequestHeader","send","event","debug","readyState","on_response","on_loading","on_end","response","status","clearTimeout","statusCode","loading","end","responseText","defaults","requester","def","d","params","undefined","de","get","post","put","head","shortcuts","forEach","shortcut","toUpperCase","func","opts","args","concat","Array","prototype","slice","apply","arguments","couch","couch_handler","resp","reason","logger","levels","level","console","formatted","formatted_logger","context","call","window","location","rurl","ajaxLocation","href","e","document","createElement","ajaxLocParts","exec","parts","data","b64","o1","o2","o3","h1","h2","h3","h4","bits","ac","enc","tmp_arr","charCodeAt","charAt","module","exports"],"mappings":"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","sourcesContent":["// Browser Request\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nvar XHR = XMLHttpRequest\nif (!XHR) throw new Error('missing XMLHttpRequest')\nrequest.log = {\n  'trace': noop, 'debug': noop, 'info': noop, 'warn': noop, 'error': noop\n}\n\nvar DEFAULT_TIMEOUT = 3 * 60 * 1000 // 3 minutes\n\n//\n// request\n//\n\nfunction request(options, callback) {\n  // The entry-point to the API: prep the options object and pass the real work to run_xhr.\n  if(typeof callback !== 'function')\n    throw new Error('Bad callback given: ' + callback)\n\n  if(!options)\n    throw new Error('No options given')\n\n  var options_onResponse = options.onResponse; // Save this for later.\n\n  if(typeof options === 'string')\n    options = {'uri':options};\n  else\n    options = JSON.parse(JSON.stringify(options)); // Use a duplicate for mutating.\n\n  options.onResponse = options_onResponse // And put it back.\n\n  if (options.verbose) request.log = getLogger();\n\n  if(options.url) {\n    options.uri = options.url;\n    delete options.url;\n  }\n\n  if(!options.uri && options.uri !== \"\")\n    throw new Error(\"options.uri is a required argument\");\n\n  if(typeof options.uri != \"string\")\n    throw new Error(\"options.uri must be a string\");\n\n  var unsupported_options = ['proxy', '_redirectsFollowed', 'maxRedirects', 'followRedirect']\n  for (var i = 0; i < unsupported_options.length; i++)\n    if(options[ unsupported_options[i] ])\n      throw new Error(\"options.\" + unsupported_options[i] + \" is not supported\")\n\n  options.callback = callback\n  options.method = options.method || 'GET';\n  options.headers = options.headers || {};\n  options.body    = options.body || null\n  options.timeout = options.timeout || request.DEFAULT_TIMEOUT\n\n  if(options.headers.host)\n    throw new Error(\"Options.headers.host is not supported\");\n\n  if(options.json) {\n    options.headers.accept = options.headers.accept || 'application/json'\n    if(options.method !== 'GET')\n      options.headers['content-type'] = 'application/json'\n\n    if(typeof options.json !== 'boolean')\n      options.body = JSON.stringify(options.json)\n    else if(typeof options.body !== 'string' && options.body !== null)\n      options.body = JSON.stringify(options.body)\n  }\n  \n  //BEGIN QS Hack\n  var serialize = function(obj) {\n    var str = [];\n    for(var p in obj)\n      if (obj.hasOwnProperty(p)) {\n        str.push(encodeURIComponent(p) + \"=\" + encodeURIComponent(obj[p]));\n      }\n    return str.join(\"&\");\n  }\n  \n  if(options.qs){\n    var qs = (typeof options.qs == 'string')? options.qs : serialize(options.qs);\n    if(options.uri.indexOf('?') !== -1){ //no get params\n        options.uri = options.uri+'&'+qs;\n    }else{ //existing get params\n        options.uri = options.uri+'?'+qs;\n    }\n  }\n  //END QS Hack\n  \n  //BEGIN FORM Hack\n  var multipart = function(obj) {\n    //todo: support file type (useful?)\n    var result = {};\n    result.boundry = '-------------------------------'+Math.floor(Math.random()*1000000000);\n    var lines = [];\n    for(var p in obj){\n        if (obj.hasOwnProperty(p)) {\n            lines.push(\n                '--'+result.boundry+\"\\n\"+\n                'Content-Disposition: form-data; name=\"'+p+'\"'+\"\\n\"+\n                \"\\n\"+\n                obj[p]+\"\\n\"\n            );\n        }\n    }\n    lines.push( '--'+result.boundry+'--' );\n    result.body = lines.join('');\n    result.length = result.body.length;\n    result.type = 'multipart/form-data; boundary='+result.boundry;\n    return result;\n  }\n  \n  if(options.form){\n    if(typeof options.form == 'string') throw('form name unsupported');\n    if(options.method === 'POST'){\n        var encoding = (options.encoding || 'application/x-www-form-urlencoded').toLowerCase();\n        options.headers['content-type'] = encoding;\n        switch(encoding){\n            case 'application/x-www-form-urlencoded':\n                options.body = serialize(options.form).replace(/%20/g, \"+\");\n                break;\n            case 'multipart/form-data':\n                var multi = multipart(options.form);\n                //options.headers['content-length'] = multi.length;\n                options.body = multi.body;\n                options.headers['content-type'] = multi.type;\n                break;\n            default : throw new Error('unsupported encoding:'+encoding);\n        }\n    }\n  }\n  //END FORM Hack\n\n  // If onResponse is boolean true, call back immediately when the response is known,\n  // not when the full request is complete.\n  options.onResponse = options.onResponse || noop\n  if(options.onResponse === true) {\n    options.onResponse = callback\n    options.callback = noop\n  }\n\n  // XXX Browsers do not like this.\n  //if(options.body)\n  //  options.headers['content-length'] = options.body.length;\n\n  // HTTP basic authentication\n  if(!options.headers.authorization && options.auth)\n    options.headers.authorization = 'Basic ' + b64_enc(options.auth.username + ':' + options.auth.password);\n\n  return run_xhr(options)\n}\n\nvar req_seq = 0\nfunction run_xhr(options) {\n  var xhr = new XHR\n    , timed_out = false\n    , is_cors = is_crossDomain(options.uri)\n    , supports_cors = ('withCredentials' in xhr)\n\n  req_seq += 1\n  xhr.seq_id = req_seq\n  xhr.id = req_seq + ': ' + options.method + ' ' + options.uri\n  xhr._id = xhr.id // I know I will type \"_id\" from habit all the time.\n\n  if(is_cors && !supports_cors) {\n    var cors_err = new Error('Browser does not support cross-origin request: ' + options.uri)\n    cors_err.cors = 'unsupported'\n    return options.callback(cors_err, xhr)\n  }\n\n  xhr.timeoutTimer = setTimeout(too_late, options.timeout)\n  function too_late() {\n    timed_out = true\n    var er = new Error('ETIMEDOUT')\n    er.code = 'ETIMEDOUT'\n    er.duration = options.timeout\n\n    request.log.error('Timeout', { 'id':xhr._id, 'milliseconds':options.timeout })\n    return options.callback(er, xhr)\n  }\n\n  // Some states can be skipped over, so remember what is still incomplete.\n  var did = {'response':false, 'loading':false, 'end':false}\n\n  xhr.onreadystatechange = on_state_change\n  xhr.open(options.method, options.uri, true) // asynchronous\n  if(is_cors)\n    xhr.withCredentials = !! options.withCredentials\n\n  for (var key in options.headers)\n    xhr.setRequestHeader(key, options.headers[key])\n\n  xhr.send(options.body)\n  return xhr\n\n  function on_state_change(event) {\n    if(timed_out)\n      return request.log.debug('Ignoring timed out state change', {'state':xhr.readyState, 'id':xhr.id})\n\n    request.log.debug('State change', {'state':xhr.readyState, 'id':xhr.id, 'timed_out':timed_out})\n\n    if(xhr.readyState === 1) {\n      request.log.debug('Request started', {'id':xhr.id})\n    }\n\n    else if(xhr.readyState === 2)\n      on_response()\n\n    else if(xhr.readyState === 3) {\n      on_response()\n      on_loading()\n    }\n\n    else if(xhr.readyState === 4) {\n      on_response()\n      on_loading()\n      on_end()\n    }\n  }\n\n  function on_response() {\n    if(did.response)\n      return\n\n    did.response = true\n    request.log.debug('Got response', {'id':xhr.id, 'status':xhr.status})\n    clearTimeout(xhr.timeoutTimer)\n    xhr.statusCode = xhr.status // Node request compatibility\n\n    // Detect failed CORS requests.\n    if(is_cors && xhr.statusCode == 0) {\n      var cors_err = new Error('CORS request rejected: ' + options.uri)\n      cors_err.cors = 'rejected'\n\n      // Do not process this request further.\n      did.loading = true\n      did.end = true\n\n      return options.callback(cors_err, xhr)\n    }\n\n    options.onResponse(null, xhr)\n  }\n\n  function on_loading() {\n    if(did.loading)\n      return\n\n    did.loading = true\n    request.log.debug('Response body loading', {'id':xhr.id})\n    // TODO: Maybe simulate \"data\" events by watching xhr.responseText\n  }\n\n  function on_end() {\n    if(did.end)\n      return\n\n    did.end = true\n    request.log.debug('Request done', {'id':xhr.id})\n\n    xhr.body = xhr.responseText\n    if(options.json) {\n      try        { xhr.body = JSON.parse(xhr.responseText) }\n      catch (er) { return options.callback(er, xhr)        }\n    }\n\n    options.callback(null, xhr, xhr.body)\n  }\n\n} // request\n\nrequest.withCredentials = false;\nrequest.DEFAULT_TIMEOUT = DEFAULT_TIMEOUT;\n\n//\n// defaults\n//\n\nrequest.defaults = function(options, requester) {\n  var def = function (method) {\n    var d = function (params, callback) {\n      if(typeof params === 'string')\n        params = {'uri': params};\n      else {\n        params = JSON.parse(JSON.stringify(params));\n      }\n      for (var i in options) {\n        if (params[i] === undefined) params[i] = options[i]\n      }\n      return method(params, callback)\n    }\n    return d\n  }\n  var de = def(request)\n  de.get = def(request.get)\n  de.post = def(request.post)\n  de.put = def(request.put)\n  de.head = def(request.head)\n  return de\n}\n\n//\n// HTTP method shortcuts\n//\n\nvar shortcuts = [ 'get', 'put', 'post', 'head' ];\nshortcuts.forEach(function(shortcut) {\n  var method = shortcut.toUpperCase();\n  var func   = shortcut.toLowerCase();\n\n  request[func] = function(opts) {\n    if(typeof opts === 'string')\n      opts = {'method':method, 'uri':opts};\n    else {\n      opts = JSON.parse(JSON.stringify(opts));\n      opts.method = method;\n    }\n\n    var args = [opts].concat(Array.prototype.slice.apply(arguments, [1]));\n    return request.apply(this, args);\n  }\n})\n\n//\n// CouchDB shortcut\n//\n\nrequest.couch = function(options, callback) {\n  if(typeof options === 'string')\n    options = {'uri':options}\n\n  // Just use the request API to do JSON.\n  options.json = true\n  if(options.body)\n    options.json = options.body\n  delete options.body\n\n  callback = callback || noop\n\n  var xhr = request(options, couch_handler)\n  return xhr\n\n  function couch_handler(er, resp, body) {\n    if(er)\n      return callback(er, resp, body)\n\n    if((resp.statusCode < 200 || resp.statusCode > 299) && body.error) {\n      // The body is a Couch JSON object indicating the error.\n      er = new Error('CouchDB error: ' + (body.error.reason || body.error.error))\n      for (var key in body)\n        er[key] = body[key]\n      return callback(er, resp, body);\n    }\n\n    return callback(er, resp, body);\n  }\n}\n\n//\n// Utility\n//\n\nfunction noop() {}\n\nfunction getLogger() {\n  var logger = {}\n    , levels = ['trace', 'debug', 'info', 'warn', 'error']\n    , level, i\n\n  for(i = 0; i < levels.length; i++) {\n    level = levels[i]\n\n    logger[level] = noop\n    if(typeof console !== 'undefined' && console && console[level])\n      logger[level] = formatted(console, level)\n  }\n\n  return logger\n}\n\nfunction formatted(obj, method) {\n  return formatted_logger\n\n  function formatted_logger(str, context) {\n    if(typeof context === 'object')\n      str += ' ' + JSON.stringify(context)\n\n    return obj[method].call(obj, str)\n  }\n}\n\n// Return whether a URL is a cross-domain request.\nfunction is_crossDomain(url) {\n  // Fix for React Native. CORS does noet exist in that environment\n  if (! window.location) {\n    return false;\n  }\n\n  var rurl = /^([\\w\\+\\.\\-]+:)(?:\\/\\/([^\\/?#:]*)(?::(\\d+))?)?/\n\n  // jQuery #8138, IE may throw an exception when accessing\n  // a field from window.location if document.domain has been set\n  var ajaxLocation\n  try { ajaxLocation = location.href }\n  catch (e) {\n    // Use the href attribute of an A element since IE will modify it given document.location\n    ajaxLocation = document.createElement( \"a\" );\n    ajaxLocation.href = \"\";\n    ajaxLocation = ajaxLocation.href;\n  }\n\n  var ajaxLocParts = rurl.exec(ajaxLocation.toLowerCase()) || []\n    , parts = rurl.exec(url.toLowerCase() )\n\n  var result = !!(\n    parts &&\n    (  parts[1] != ajaxLocParts[1]\n    || parts[2] != ajaxLocParts[2]\n    || (parts[3] || (parts[1] === \"http:\" ? 80 : 443)) != (ajaxLocParts[3] || (ajaxLocParts[1] === \"http:\" ? 80 : 443))\n    )\n  )\n\n  //console.debug('is_crossDomain('+url+') -> ' + result)\n  return result\n}\n\n// MIT License from http://phpjs.org/functions/base64_encode:358\nfunction b64_enc (data) {\n    // Encodes string using MIME base64 algorithm\n    var b64 = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\";\n    var o1, o2, o3, h1, h2, h3, h4, bits, i = 0, ac = 0, enc=\"\", tmp_arr = [];\n\n    if (!data) {\n        return data;\n    }\n\n    // assume utf8 data\n    // data = this.utf8_encode(data+'');\n\n    do { // pack three octets into four hexets\n        o1 = data.charCodeAt(i++);\n        o2 = data.charCodeAt(i++);\n        o3 = data.charCodeAt(i++);\n\n        bits = o1<<16 | o2<<8 | o3;\n\n        h1 = bits>>18 & 0x3f;\n        h2 = bits>>12 & 0x3f;\n        h3 = bits>>6 & 0x3f;\n        h4 = bits & 0x3f;\n\n        // use hexets to index into b64, and append result to encoded string\n        tmp_arr[ac++] = b64.charAt(h1) + b64.charAt(h2) + b64.charAt(h3) + b64.charAt(h4);\n    } while (i < data.length);\n\n    enc = tmp_arr.join('');\n\n    switch (data.length % 3) {\n        case 1:\n            enc = enc.slice(0, -2) + '==';\n        break;\n        case 2:\n            enc = enc.slice(0, -1) + '=';\n        break;\n    }\n\n    return enc;\n}\nmodule.exports = request;\n"]},"metadata":{},"sourceType":"script"}